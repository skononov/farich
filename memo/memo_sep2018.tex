
\documentclass[12pt]{article}

\usepackage[a4paper]{geometry}
\usepackage{cmap} %for right cyrillic encoding in PDF files
\usepackage[T2A]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage[russian]{babel}
\usepackage{graphicx}
\usepackage{color}
\usepackage[unicode=true,pdfborder={0 0 0}]{hyperref}
\usepackage{caption}
\usepackage{amssymb,amsmath}
\usepackage{mathtext}
\usepackage{xspace}
\usepackage{hyperref}

\input{/home/skononov/tex/defs}
\input{/home/skononov/tex/tabledefs}

\textheight 24cm
\textwidth 16cm
\topmargin 0cm
\oddsidemargin -.5cm
\footskip 1.5cm

\newcommand{\lsc}{$L_\mathrm{sc}$\xspace}
\newcommand{\betaop}{$\beta_\mathrm{0}$\xspace}

\title{\Large\bf Меморандум по оптимизации радиатора ФАРИЧ}
\author{\large н.с. лаб. 3-2 Кононов С.А.}
\date{\large 27.09.2018 г.}

\begin{document}
\maketitle

\section{Расчет разрешения ФАРИЧ. Теория.}
Число черенковских фотонов на единицу длины волны излучения и единицу пути частицы в среде (радиаторе):
\begin{equation}
\frac{d^2N}{dx d\lambda} = \frac{2\pi\alpha z^2}{\lambda^2}\left(1 - \frac{1}{\beta^2 n^2(\lambda)}\right),
\label{eq:cherint}
\end{equation}
где $x$ -- координата вдоль пути частицы, $\lambda$ -- длина волны излучения,
$n(\lambda)$ -- показатель преломления в среде с дисперсией,
$\beta$ -- скорость частицы в единицах скорости света в вакууме $c$, $z$ -- заряд частицы в единицах элементарного заряда, 
$\alpha\approx 1/137$ -- постоянная тонкой структуры.

Формулу (\ref{eq:cherint}) можно также использовать для неоднородной среды, которой является аэрогелевый радиатор детектора ФАРИЧ, вводя
зависимость показателя преломления от координаты вдоль пути частицы $n(x,\lambda)$.

Для фотонного детектора с эффективностью регистрации $\mathrm{PDE}(\lambda)$ и радиатора с коэффициентом сбора 
фотонов $\mathrm{LC}(x,\lambda)$ число зарегистрированных фотонов равно:
\begin{equation}
\frac{d^2N_\mathrm{pe}}{dx d\lambda} = \frac{2\pi\alpha z^2}{\lambda^2}\left(1 - \frac{1}{\beta^2 n^2(x,\lambda)}\right)
\mathrm{PDE}(\lambda)\mathrm{LC}(x,\lambda).
\label{eq:cherintdet}
\end{equation}

Расчет разрешения детектора ФАРИЧ производится в рассмотрении, когда радиатор представляет из себя множество граничащих между собой плоскопараллельных слоев аэрогеля диоксида кремния, 
расположенных перпендикулярно направлению частицы. Слои аэрогеля характеризуются своей толщиной и показателем преломления, поглощение фотонов --- 
одинаковое для всех слоев и определяется только длиной пути фотона в радиаторе и длиной поглощения. Рэлеевское рассеяние фотонов в аэрогеле считается эквивалентным поглощению, 
так как при этом теряется информация о направлении излучения фотона, а фоном, который создается рассеяными фотонами от одной частицы можно пренебречь в практически важных случаях. 
Плоскость входного окна координатночувствительного фотонного детектора расположена параллельно плоскости радиатора на некотором расстоянии от радиатора. 
Между радиатором и фотонным детектором расположена абсолютно прозрачная среда с показателем преломления равным единице (``воздух''). 
В этом случае черенковские фотоны создают распределение в плоскости входного окна фотонного детектора в форме колец или кольца с центром 
совпадающим с положением частицы. Здесь рассматривается вариант однокольцевого детектора ФАРИЧ, когда показатели преломления и толщины 
слоев аэрогеля для некоторой заданной скорости частицы подбираются такими, чтобы распределения фотонов в плоскости фотонного детектора от каждого слоя совпадали наилучшим образом.
На Рис.~\ref{fig:farich} для наглядности показана схема детектора ФАРИЧ с используемыми координатами и обозначениями.

\begin{figure}[h]
\begin{center}
\includegraphics[width=0.4\textheight]{farich_scheme.pdf}
\caption{\small Схема детектора ФАРИЧ для четырех слоев аэрогеля.}
\label{fig:farich}
\end{center}
\end{figure}

В расчете ФАРИЧ вычисляется распределение зарегистрированных фотонов (фотоэлектронов) по радиусу, средний радиус кольца, 
стандартная ошибка измерения радиуса для единичных фотонов, стандартная ошибка измерения радиуса кольца для единичной частицы и соответствующие 
ошибки по углу $\theta$, задаваемым выражением 
\(\tan\theta = \frac{R}{D_{1/2}},\)
где $R$ -- радиус фотонов, $D_{1/2}$ -- расстояние от срединной плоскости радиатора до фотонного детектора.
В силу того, что показатель преломления аэрогеля в практике близок к 1, а, значит, изменение направления фотонов на границах сред небольшое,
то можно считать, что угол $\theta$ --- это эффективный черенковский угол радиатора, который для данного радиатора определяется только скоростью частицы. 
Разрешение по углу $\theta$ (угловое разрешение) можно использовать для сравнения разных детекторов ФАРИЧ с фиксированным максимальным показателем преломления 
аэрогеля, в частности для оптимизации детектора ФАРИЧ по угловому разрешению.
Ошибка по углу, $\sigma(\theta)$, определяется из ошибки по радиусу $\sigma(R)$:
\[\sigma(\theta) = \frac{\sigma(R) D_{1/2}}{D_{1/2}^2+R^2}.\]

Для расчета необходимо определить на какой радиус в плоскости фотонного детектора приходят фотоны с длиной волны $\lambda$, излученные в точке $x_0$ вдоль пути частицы в
радиаторе. Для этого необходимо проинтегрировать приращения радиуса фотонов при изменении координаты $x$ фотона от $x_0$ до попадания в фотонный детектор ($x=D$):
\begin{equation}
R(x_0,\lambda) = \int_{x_0}^D \tan\psi(x_0,x;\lambda) dx,
\label{eq:rx0psi}
\end{equation}
где $\psi(x_0,x;\lambda)$ -- это угол между направлением частицы и фотоном в точке с координатой $x$, который излучен в точке $x_0$, а интегрирование берется по всем $x$ от 
точки излучения до фотонного детектора. Угол $\psi$ в точке излучения фотона всегда равен черенковскому углу $\psi(x_0,x_0;\lambda) \equiv \theta_c = \arccos{1/n(x_0,\lambda)\beta}$, а 
в любой другой точке его можно определить из закона преломления Снелля:
\[n(x_0,\lambda)\sin\psi(x_0,x_0;\lambda) = n(x,\lambda)\sin\psi(x_0,x;\lambda).\]
В итоге можно получить выражение для тангенса угла $\psi$:
\begin{equation}
\tan\psi(x_0,x;\lambda) = \sqrt{\frac{n^2(x_0,\lambda)\beta^2-1}{n^2(x,\lambda)\beta^2-n^2(x_0,\lambda)\beta^2+1}},
\label{eq:tanpsi}
\end{equation}

Подставляя (\ref{eq:tanpsi}) в (\ref{eq:rx0psi}), получаем что радиус фотона в плоскости фотонного детектора равен
\begin{equation}
R(x_0,\lambda) = (D-T)\sqrt{\frac{n(x_0,\lambda)\beta^2-1}{(1-n^2(x_0,\lambda))\beta^2+1}} + 
\int_{x_0}^T \sqrt{\frac{n(x_0,\lambda)\beta^2-1}{n^2(x,\lambda)\beta^2-n^2(x_0,\lambda)\beta^2+1}} dx,
\label{eq:rx0}
\end{equation}

В расчете используется дисперсия показателя преломления, измеренная в работе \cite{aerdisp} для 
образца новосибирского аэрогеля, где показатель преломления в зависимости от длины волны описывается уравнением
\[n^2(\lambda)-1 = \frac{a_0 \lambda^2}{\lambda^2-\lambda_0^2},\]
где $a_0 = 0.05639$, $\lambda_0 = 83.22\,\textrm{нм}$. 
Для расчета аэрогелей с иной плотностью зависимость показателя преломления получается соответствующим измененем 
коэффициента $a_0$.

Расчет учитывает потерю прямого света из-за эффекта рэлеевского рассеяния, которое определяется длиной рассеяния $L_\textrm{sc}(\lambda)$.
Типовая длина рассеяния для новосибирского аэрогеля составляет 50\,мм при длине волны 400\,нм. Далее везде в расчетах используется это значение. 
Поглощением света в аэрогеле детектора черенковских колец можно пренебречь по сравнению потерями прямого света за счет рассеяния. Существуют также потери
прямого света при рассеянии на выходной поверхности аэрогеля, составляющие 2--5\% и независящие от длины волны.
Коэффициент светосбора $\mathrm{LC}$ в уравнении (\ref{eq:cherintdet}) в случае ФАРИЧ можно записать как \cite{aerscat}:
\[\mathrm{LC}(x_0,\lambda) = A \exp\left(-\frac{s(x_0,\lambda)}{L_\textrm{sc}(400\,\textrm{нм})\left(\lambda / 400\,\textrm{нм}\right)^4}\right),\]
где $A$ -- коэффициент рассеяния на выходной поверхности аэрогеля, $s(x_0,\lambda)$ -- длина пути фотона с длиной волны $\lambda$, 
возникающего в точке $x_0$, в радиаторе, которую можно найти с помощью интеграла:
\begin{equation}
s(x_0,\lambda) = \int_{x_0}^T \sqrt{1+\tan^2\psi(x_0,x;\lambda)} dx.
\label{eq:path}
\end{equation}

Для многослойного радиатора интегралы в (\ref{eq:tanpsi}), (\ref{eq:rx0}) и (\ref{eq:path}), очевидно, можно записать в виде соответствующих сумм по слоям радиатора, 
что опускается здесь.

Проинтегрировав по длине волны (\ref{eq:cherintdet}), произведя замену переменной $x_0\to R$, можно получить распределение числа фотоэлектронов по радиусу:
\begin{equation}
\frac{dN_\mathrm{pe}}{dR}(R) = \int_{\lambda_1}^{\lambda_2} d\lambda \sum_i \frac{d^2N_\mathrm{pe}}{dx d\lambda}(x_i(\lambda),\lambda)
\left|\frac{\partial R}{\partial x}(x_i(\lambda),\lambda)\right|^{-1},
\label{eq:dnpedr}
\end{equation}
где $\lambda_1,\,\lambda_2$ -- регистрируемый фотонным детектором диапазон длин волн, $x_i$ --- корни уравнения 
\[R(x,\lambda)=R\] 
по $x$ для соответствующей $\lambda$, то есть все точки вдоль пути частицы в радиаторе, из которых фотоны с длиной волны 
$\lambda$ попадают на радиус $R$. В случае многослойного радиатора из уравнения (\ref{eq:rx0psi}) следует, что
\[\frac{\partial R}{\partial x}(x,\lambda) = \tan\psi(x,x;\lambda).\]
Видно, что частные производные $\frac{\partial R}{\partial x}$ являются ненулевыми, а их обратные значения, входящие в (\ref{eq:dnpedr}), конечные. 
При расчете числа фотоэлектронов в малом интервале $(R_i,R_i+\Delta R)$ сумму под интегралом в (\ref{eq:dnpedr}) нужно брать по всем слоям радиатора, дающим вклад в этот 
интервал, а производные $\frac{\partial R}{\partial x}$ можно приблизительно заменить на $\frac{\Delta R}{\Delta x}$, где $\Delta x$ --- максимальный отрезок пути частицы 
в слое радиатора, дающий вклад в данный интервал радиусов.

\section{Программа FARICHRES}
\subsection{Общее описание программы}
Программа FARICHRES оптимизирует распределение черенковских фотонов в детекторе 
черенковских колец с фокусирующим аэрогелевым радиатором ФАРИЧ и в результате выдает описание оптимального радиатора и 
расчет однофотонного распределения по радиусу кольца и разрешение. 
Программа написана на языке C++ под операционную систему Linux, использует пакет физического анализа ROOT \cite{root} и библиотеку GSL \cite{gsl}.

Справка по использованию программы FARICHRES:
\begin{verbatim}
Usage: ./farichres [OPTIONS] qefile
Вычисляет разрешение детектора черенковских колец с многослойным фокусирующим 
аэрогелем. Оптимизирует разрешение. Параметр qefile задает путь к файлу с 
данными о квантовой эффективности фотонного детектора, представленых в двух 
колонках: длина волны (нм), эффективность (%).

 OPTIONS:
   -q                Задачный режим без графики и интерпретатора
   -e eff            Фактор к эффективности фотонного детектора, 0<eff<=1 
                     (default: 1)
   -p size           Размер квадратного пикселя фотонного детектора, мм 
                     (default: 0)
   -D distance       Расстояние от начала радиатора до фотонного детектора, мм 
                     (default: 100)
   -n ri1            Максимальный показатель преломления радиатора на 400 нм 
                     (default: 1.07)
   -N nlayers        Число слоев аэрогеля, 0<nlayers<=100 (default: 3)
   -T thickness      Толщина радиатора, мм (default: 25)
   -s Lsc            Длина рассеяния на 400 нм, мм (default: 50)
   -b beta           Оптимизировать радиатор для данной скорости частицы, 
                     1/ri1<beta<=1 (default: 1)
   -B beta           Сделать расчет для данной скорости частицы, 1/ri1<beta<=1 
                     (default: скорость частицы для оптимизации)
   -m [param]        Оптимизировать радиатор по угловой ошибке на трек, 
                     используя параметризацию param: nt или polN (N=1..10) 
                     (default: nt)
   -o filename       Сохранить гистограмму распределения по радиусу в заданный 
                     ROOT-файл (default: farichres.root)
   -O filename       Сохранить описание детектора в заданный командный файл 
                     Geant4. По умолчанию - не сохранять.
\end{verbatim}

Радиатор описывается заданным числом слоев $N_l$ (опция {\tt -N nlayers}) аэрогеля с заданной суммарной толщиной $T$ (опция {\tt -T thickness}) и 
заданным показателем преломления в {\em первом}\footnote{Первый слой --- слой, ближайший к фотодетектору} слое радиатора $n_1$ (опция {\tt -n ri1}). 
Расстояние $D$ от входной поверхности (дальней от фотодетектора) до входного окна фотодетектора задается опцией {\tt -D distance}.
Длина рэлеевского рассеяния света в аэрогеле \lsc при длине волны 400\,нм задается опцией {\tt -s Lsc} (\lsc --- одна и та же для всего радиатора). 
Скорость частицы \betaop в единицах скорости света вакууме, для которой оптимизируется радиатор, задается опцией {\tt -b beta}. 
Можно также задать скорость частицы $\beta$, для которой производится финальный расчет разрешения, опцией {\tt -B beta}.
Эффективность фотонного детектора в зависимости от длины волны задается текстовым файлом в качестве единственного аргумента программы. 
Эту эффективность можно уменьшить, задав коэффициент $\varepsilon$ опцией {\tt -e eff}, учитывая таким образом иные источники потерь черенковского света. 
Размер стороны квадратного пикселя фотодетектора $a$ задается опцией {\tt -p size}. Результат расчета радиатора в виде гистограмм и дерева записывается 
в ROOT-файл, заданный опцией {\tt -o filename}. Также с помощью опции {\tt -O filename} можно сохранить описание радиатора в формате макроса Geant4 
для программы моделирования ФАРИЧ.

В качестве результата программа выдает гистограмму распределения фотонов по радиусу кольца без учета координатного разрешения фотодетектора, гистограмму
распределения показателя по слоям аэрогеля, а также рассчитанные ошибки радиуса и черенковского угла на один фотон и на трек. 
Дополнительно рассчитываются ошибки, учитывающие вклад координатного разрешения 
фотодетектора, для этого к однофотонной ошибке по радиусу квадратично добавляется величина $\frac{a}{\sqrt{12}}$.

Перед расчетом радиатор оптимизируется с помощью быстрого метода численным решением системы уравнений, которые
выражают условия, чтобы при некоторой длине волны границы колец от каждого слоя 
совпадали в плоскости фотонного детектора. Длина волны приблизительно соответствует
максимуму спектра регистрируемых черенковских фотонов из радиатора. 

Если указана опция {\tt -m [param]}, проводится минимизация ошибки черенковского угла на трек методом Migrad библиотеки Minuit2 из пакета анализа ROOT \cite{minuit2}. 
Методы библиотеки Minuit2 не позволяет выполнить условную минимизацию с условием фиксированной полной толщине радиатора, варьируя показатели преломления и толщины слоев. 
Для применения Minuit2 требуется переопределить параметры, задающие толщины слоев так, чтобы эти параметры можно было сделать свободными с независимо заданными пределами.

Реализованы следующие два варианта параметризации толщин и показателей преломления слоев:
\begin{enumerate}
\item NT-параметризация (опция {\tt -m nt});
\item полиномиальная параметризация (опция {\tt -m pol$N$}, где $1\leq N \leq 10$).
\end{enumerate}
В обоих вариантах показатель преломления первого слоя $n_1$ и полная толщина радиатора $T$ --- фиксированы, как и полное число слоев $N_l$.


\subsection{Быстрая оптимизация радиатора}


\subsection{NT-параметризация}
Можно определить невырожденную матрицу преобразования вектора толщин слоев $\boldsymbol{t}=(t_1,t_2,\ldots\,,t_{N_l})$ в вектор 
специальных параметров $\boldsymbol{u}=(u_1,u_2,\ldots,u_{N_l})$, в котором полная толщина задается одним из параметров $u_i$, 
а остальные определяют подпространство значений толщин $\boldsymbol{t}$, в котором полная толщина неизменна. 
Ортогональную матрицу такого преобразования можно получить с помощью сингулярного 
разложения однострочной матрицы $1\times N_l$ $M=(1,1,\ldots,1)$, являющейся матрицей коэффициентов линейного уравнения:
\begin{equation}
t_1+t_2+\ldots+t_{N_l} = T.
\label{eq:totthick}
\end{equation}
В результате данного разложения матрица $M$ представляется в виде произведения трех матриц $M=U\Sigma V^T$, где $U=1$ или $-1$,
$V^T$ --- искомая ортогональная матрица размером $N_l\times N_l$, а $\Sigma$ --- матрица $1\times N_l$ с положительным первым элементом (сингулярным числом матрицы $M$) и остальными 
нулевыми элементами. Вектор $\boldsymbol{u} = V^T \boldsymbol{t}$ задает толщины слоев радиатора, при этом первый элемент $u_1$ определяет полную толщину. 
Можно сказать, что $V^T$ является матрицей перехода в  базис векторного пространства, в котором первый базисный вектор нормален гиперплоскости, задаваемой уравнением (\ref{eq:totthick}).

Сингулярное разложение выполняется с помощью класса TDecompSVD пакета ROOT. В силу того, что TDecompSVD требует, чтобы разлагаемая матрица 
имела число строк не менее, чем число столбцов, матрица $M$ преобразуется в квадратную добавлением $N_l-1$ нулевых строк, что не влияет на свойства ортогональной матрицы $V$.

Свободными параметрами минимизации являются $N_l-1$ показателей преломления слоев $n_i, i=2..N_l$ и $N_l-1$ параметров $u_i, i=2..N_l$. 
Полное число свободных параметров равно $2\,N_l - 2$.

\subsection{Полиномиальная параметризация}
В этом варианте распределение показателя преломления по толщине радиатора описывается с помощью значений многочлена степени $k$ по $x$ в серединах одинаковых по толщине 
слоев радиатора:
\begin{equation}
Q_k(x) = n_1+(x-x_1)P_{k-1}(x),
\label{eq:polpar}
\end{equation}
где $P_{k-1}(x)$ -- произвольный многочлен степени $k-1$, а $n_1,\,x_1$ -- показатель преломления и координата середины первого слоя. 
Можно видеть, что многочлен $Q_k(x)$ всегда принимает значение $n_1$ в середине первого слоя. 
Свободными параметрами минимизации являются $k$ коэффициентов многочлена $P_{k-1}(x)$. Поскольку число свободных параметров, а значит соответствующая 
вычислительная сложность минимизации, не зависит от числа слоев, то число слоев можно взять большим.

Для оптимального описания распределения показателя в радиаторе с числом слоев порядка 100 
достаточно многочлена $Q_2(x)$ второй степени, имеющего всего два свободных параметра. При дальнейшем увеличении степени многочлена 
угловая ошибка для оптимизированного радиатора меняется незначительно.

\section*{Результаты расчета}

\subsection*{Разрешение в зависимости от числа слоев}
\begin{figure}[htb]
\begin{center}
\includegraphics[width=0.8\textwidth]{angres_vs_nl.pdf}
\caption{Ошибка черенковского угла на трек в зависимости от количества слоев радиатора. Параметры расчета: $n_1=1.05$, $D=200$\,мм,\ $T=40$\,мм,\ $\beta=1$, фотодетектор: MPPC 13161-3050HS, eff=0.82}
\end{center}
\end{figure}


\subsection*{Сравнение методов оптимизации радиатора}

\section*{Сравнение результатов расчета с моделированием}

\begin{thebibliography}{99}
\bibitem{root} Вебсайт ROOT [\url{https://root.cern.ch/}]
\bibitem{gsl} Вебсайт GNU Scientific Library [\url{http://www.gnu.org/software/gsl/}]
\bibitem{aerdisp} T. Bellunato et al., ``Refractive index dispersion law of silica aerogel'',
European Physics Journal C 52 (2007) 759-764
\bibitem{aerscat} A.F. Danilyuk et al., ``Recent results on aerogel development for use in Cherenkov counters'',
Nuclear Instruments and Methods in Physics Research A 494 (2002) 491–494
\bibitem{minuit2} Minuit2 User Guide [\url{https://root.cern.ch/root/htmldoc/guides/minuit2/Minuit2.html}]
\end{thebibliography}

\end{document}
